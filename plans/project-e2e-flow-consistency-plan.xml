<?xml version="1.0" encoding="UTF-8"?>
<plan version="1.2">
  <meta>
    <title>프로젝트별 E2E 데이터 플로우 일관성 강화 계획 (영업→설계→자재/구매→생산)</title>
    <created>2026-02-10</created>
    <updated>2026-02-10</updated>
    <owner>planner</owner>
    <context>
      <repoRoot>.</repoRoot>
      <planPath>plans/project-e2e-flow-consistency-plan.xml</planPath>
      <objective>프로젝트 단위로 문서/재고/공정/회계 데이터 추적을 끊김 없이 유지</objective>
      <policy><![CDATA[
결정 정책:
- 기본: 1 PO = 1 프로젝트
- 혼합 프로젝트 PR 선택 시 실패가 아니라 "프로젝트별 자동 분할 PO 생성"을 기본 동작으로 채택
- 비프로젝트 공통재고 구매는 project_id null 허용
]]></policy>
    </context>
  </meta>

  <scope>
    <writeAllow>plans/**</writeAllow>
    <writeAllow>**/*-overview.md</writeAllow>
    <writeDeny>everything-else</writeDeny>
    <notes><![CDATA[
본 계획은 소스코드 직접 수정 없이 실행 경로를 정의한다.
오버엔지니어링을 피하기 위해 "최소 필드 추가 + 기존 UseCase/Hook 강화 + 단계적 검증" 전략을 사용한다.
]]></notes>
  </scope>

  <statusModel>
    <allowed>todo,in_progress,partial,done,blocked,failed,needs_replan</allowed>
    <transition from="todo" to="in_progress"/>
    <transition from="todo" to="needs_replan"/>
    <transition from="in_progress" to="partial"/>
    <transition from="in_progress" to="done"/>
    <transition from="in_progress" to="blocked"/>
    <transition from="in_progress" to="failed"/>
    <transition from="partial" to="in_progress"/>
    <transition from="partial" to="done"/>
    <transition from="partial" to="blocked"/>
    <transition from="partial" to="failed"/>
    <transition from="blocked" to="in_progress"/>
    <transition from="blocked" to="needs_replan"/>
    <transition from="failed" to="in_progress"/>
    <transition from="failed" to="needs_replan"/>
    <transition from="needs_replan" to="todo"/>
    <transition from="needs_replan" to="in_progress"/>
  </statusModel>

  <inventory>
    <folder path="plans/" overview="plans/plans-overview.md" status="done"/>
    <folder path="domain/" overview="domain/domain-overview.md" status="done"/>
    <folder path="hooks/" overview="hooks/hooks-overview.md" status="done"/>
    <folder path="app/" overview="app/app-overview.md" status="done"/>
    <folder path="infrastructure/" overview="infrastructure/infrastructure-overview.md" status="done"/>
    <folder path="store/" overview="store/store-overview.md" status="done"/>
    <folder path="lib/" overview="lib/lib-overview.md" status="done"/>
  </inventory>

  <phases>
    <phase id="P0" name="기준선 정의" status="done">
      <tasks>
        <task id="T0" status="done" owner="planner" dependsOn="" updatedAt="2026-02-10">
          <summary><![CDATA[현재 연결 상태와 단절 지점을 식별했다]]></summary>
          <details><![CDATA[
확인된 강점:
- 수주 생성 시 프로젝트 자동 생성(create-order-with-project)
- 설계 완료 시 프로젝트 상태 전환(progress-design-step)
- 구매요청(PR)에는 project_id가 존재
- 재고 출고(OUT)는 project_id 필수

확인된 단절:
- PurchaseOrder의 project trace 약함
- PR→PO 변환 계약이 단일 PO 반환이라 혼합 프로젝트 처리 모호
- 입고(PO receive) StockMovement의 project_id 전파 누락 가능
- STOCK_OUT 회계 이벤트 자동 게시 미연결
- 설계 이후 공정/자재 게이트의 코드 강제 부족
]]></details>
          <outputs>
            <file path="plans/project-e2e-flow-consistency-plan.xml" kind="plan"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[실행 우선순위와 차단 리스크가 문서화된다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="low"><![CDATA[일부 화면 구현과 문서 간 미세한 불일치 가능성.]]></risk>
          </risks>
        </task>
      </tasks>
    </phase>

    <phase id="P1" name="공통 데이터 계약/저장소 동기화" status="done">
      <tasks>
        <task id="T1" status="done" owner="executor" dependsOn="T0" updatedAt="2026-02-10">
          <summary><![CDATA[프로젝트 추적 필수 필드를 엔티티/포트 계약에 반영]]></summary>
          <details><![CDATA[
최소 변경 원칙:
- PurchaseOrder에 project_id? 추가 (PR 기반 PO 대표 프로젝트)
- 필요 시 PurchaseOrderItem.project_id? 추가 (기본은 PO.project_id 상속)
- StockMovement는 purchase_order_id + project_id 동시 보존
- AccountingEvent payload 표준 키 세트 고정(order_id/project_id/po_id/work_order_id/material_id/amount)
]]></details>
          <outputs>
            <file path="domain/shared/entities.ts" kind="source-edit"/>
            <file path="domain/procurement/entities.ts" kind="source-edit"/>
            <file path="domain/materials/entities.ts" kind="source-edit"/>
            <file path="domain/accounting/entities.ts" kind="source-edit"/>
            <file path="domain/procurement/ports.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[필드 추가 후에도 하위호환(optional) 유지 및 기존 데이터 읽기 실패가 없다.]]></criterion>
            <criterion><![CDATA[domain/infrastructure/hook 레이어 타입 오류 없이 build가 통과한다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="medium"><![CDATA[필드 추가 누락 시 레이어 간 타입 불일치 발생.]]></risk>
          </risks>
        </task>

        <task id="T1A" status="done" owner="executor" dependsOn="T1" updatedAt="2026-02-10">
          <summary><![CDATA[Repository/Supabase/DB 스키마 동기화]]></summary>
          <details><![CDATA[
실행:
- purchase_orders.project_id nullable 컬럼 + 인덱스 추가 마이그레이션
- 필요 시 FK(projects.id) 추가
- Supabase/in-memory repository create/update/find에 project_id 반영
- lib/supabase 조회/저장 함수에 project_id 반영

중요:
- 마이그레이션 적용 전/후 row count 비교 쿼리 기록
- 롤백 경로(컬럼/인덱스 제거) 문서화
]]></details>
          <outputs>
            <file path="supabase/migrations/*_add_project_id_to_purchase_orders.sql" kind="source-edit"/>
            <file path="lib/supabase/materials.ts" kind="source-edit"/>
            <file path="infrastructure/repositories/supabase/procurement.ts" kind="source-edit"/>
            <file path="infrastructure/repositories/in-memory/procurement.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[신규 생성/조회되는 PO에서 project_id read/write가 양 구현체(in-memory/supabase) 모두 동작한다.]]></criterion>
            <criterion><![CDATA[마이그레이션 dry-run 대비 실제 적용 후 누락 row 수가 0건이다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="high"><![CDATA[DB 반영 누락 시 애플리케이션 타입만 맞고 런타임 저장이 실패한다.]]></risk>
          </risks>
        </task>

        <task id="T2" status="done" owner="executor" dependsOn="T1A" updatedAt="2026-02-10">
          <summary><![CDATA[PR→PO 변환 정책/계약 고정(혼합 프로젝트 자동 분할)]]></summary>
          <details><![CDATA[
정책 확정:
- 공급처가 같아도 project_id가 다르면 프로젝트별 PO를 자동 생성
- ConvertRequestsToPOResult를 단일 purchaseOrder에서 purchaseOrders[]로 전환
- UI/Hook은 다건 생성 결과를 처리(성공 메시지, 링크, refresh)
]]></details>
          <outputs>
            <file path="domain/procurement/services.ts" kind="source-edit"/>
            <file path="domain/procurement/use-cases/convert-requests-to-po.ts" kind="source-edit"/>
            <file path="hooks/procurement/usePurchaseRequests.ts" kind="source-edit"/>
            <file path="hooks/procurement/usePurchaseRequestsPageData.ts" kind="source-edit"/>
            <file path="app/materials/purchase-requests/page.tsx" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[서로 다른 프로젝트 2개의 승인 PR을 동시에 전환하면 정확히 2개의 PO가 생성된다.]]></criterion>
            <criterion><![CDATA[생성된 모든 PO는 project_id가 비어 있지 않고, updatedRequests 수는 입력 승인 PR 수와 동일하다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="high"><![CDATA[기존 단일 PO 반환 계약을 사용하는 호출부가 누락되면 런타임 오류 발생.]]></risk>
          </risks>
        </task>
      </tasks>
    </phase>

    <phase id="P2" name="영업→프로젝트→설계 경계 강화" status="done">
      <tasks>
        <task id="T3" status="done" owner="executor" dependsOn="T2" updatedAt="2026-02-10">
          <summary><![CDATA[수주 생성 시 프로젝트 초기 공정(설계) 템플릿 자동 생성]]></summary>
          <details><![CDATA[
현재는 프로젝트 자동 생성까지만 보장된다.
보강:
- create-order-with-project 성공 시 DESIGN_3D/2D/REVIEW/BOM step seed
- 프로젝트 상태 CONFIRMED -> DESIGNING 전환 규칙을 START 액션에 통합
- seed idempotency 보장(중복 생성 금지)
]]></details>
          <outputs>
            <file path="domain/sales/use-cases/create-order-with-project.ts" kind="source-edit"/>
            <file path="domain/projects/ports.ts" kind="source-edit"/>
            <file path="domain/projects/use-cases/progress-design-step.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[수주 생성 후 동일 프로젝트에 설계 step가 1세트만 존재한다(중복 0건).]]></criterion>
          </acceptance>
          <risks>
            <risk severity="high"><![CDATA[idempotency 처리 누락 시 공정이 누적 생성될 수 있다.]]></risk>
          </risks>
        </task>

        <task id="T4" status="done" owner="executor" dependsOn="T3,T5" updatedAt="2026-02-10">
          <summary><![CDATA[DESIGN_BOM 완료 시 구매요청 자동 생성 연결]]></summary>
          <details><![CDATA[
DESIGN_BOM 완료를 자재/구매 시작 게이트로 사용:
- 프로젝트 BOM에서 PR 후보 생성
- project_id를 모든 PR에 강제 세팅
- 동일 BOM 버전 재트리거 시 PR 중복 생성 금지
]]></details>
          <outputs>
            <file path="hooks/projects/useProcessSteps.ts" kind="source-edit"/>
            <file path="domain/procurement/use-cases/create-purchase-requests-from-bom.ts" kind="source-edit"/>
            <file path="hooks/procurement/usePurchaseRequests.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[DESIGN_BOM 완료 시 BOM 품목 수와 PR 생성 수가 일치한다(누락 0건).]]></criterion>
            <criterion><![CDATA[같은 BOM 버전으로 재실행해도 신규 PR 생성 수는 0건이다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="medium"><![CDATA[BOM 모델 미완성 구간에서는 반자동 승인 단계가 필요할 수 있다.]]></risk>
          </risks>
        </task>
      </tasks>
    </phase>

    <phase id="P3" name="자재/구매→재고 흐름 일관화" status="done">
      <tasks>
        <task id="T5" status="done" owner="executor" dependsOn="T2" updatedAt="2026-02-10">
          <summary><![CDATA[PR/PO/입고/태그 project_id 전파를 일관 적용]]></summary>
          <details><![CDATA[
핵심:
- PR 폼의 project_id가 PO로 승계
- PO 입고 시 생성되는 StockMovement(IN)에도 project_id 채움(프로젝트 귀속 PO 한정)
- SteelTag 생성 시 po_item_id/project_id 동시 보존
- 비프로젝트 공통재고 PO는 project_id null 유지
]]></details>
          <outputs>
            <file path="hooks/procurement/usePurchaseRequestForm.ts" kind="source-edit"/>
            <file path="hooks/procurement/usePurchaseRequests.ts" kind="source-edit"/>
            <file path="domain/materials/use-cases/receive-purchase-order.ts" kind="source-edit"/>
            <file path="hooks/materials/useReceivingWorkflows.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[project_id가 있는 PO의 입고로 생성된 IN movement와 steel tag의 project_id 누락률은 0%다.]]></criterion>
            <criterion><![CDATA[project_id가 없는 공통재고 PO의 IN movement는 project_id가 null로 유지된다(오탐 0건).]]></criterion>
          </acceptance>
          <risks>
            <risk severity="medium"><![CDATA[프로젝트/공통재고 분기 조건 오류 시 데이터 오염 가능.]]></risk>
          </risks>
        </task>

        <task id="T6" status="done" owner="executor" dependsOn="T5" updatedAt="2026-02-10">
          <summary><![CDATA[프로젝트별 자재 소요/집행 조회 모델 추가]]></summary>
          <details><![CDATA[
대시보드 최소 범위:
- 프로젝트별 PR 금액, PO 금액, 입고 금액, 출고 금액
- 미입고/미출고 잔량
복잡한 BI 모델 대신 기존 store/entity 집계 훅으로 1차 구현.
]]></details>
          <outputs>
            <file path="hooks/materials/useInventoryPageData.ts" kind="source-edit"/>
            <file path="app/projects/[id]/page.tsx" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[프로젝트 상세에서 위 6개 지표(PR/PO/입고/출고/미입고/미출고)가 모두 표시된다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="low"><![CDATA[집계 연산이 커질 경우 추가 페이지네이션/서버집계가 필요할 수 있다.]]></risk>
          </risks>
        </task>
      </tasks>
    </phase>

    <phase id="P4" name="생산 공정 연동 강화" status="done">
      <tasks>
        <task id="T7" status="done" owner="executor" dependsOn="T3,T5" updatedAt="2026-02-10">
          <summary><![CDATA[WorkOrder 진행과 프로젝트/공정 상태를 동기화]]></summary>
          <details><![CDATA[
현재 useWorkOrders는 상태 업데이트만 수행한다.
보강:
- WorkOrder 생성 시 process_step_id 필수화(해당 프로젝트 step 귀속)
- START/COMPLETE 시 process_step.status 및 project.status 동기화
- 설계완료 이후 MATERIAL_PREP/MACHINING 진입 게이트 적용
]]></details>
          <outputs>
            <file path="hooks/production/useWorkOrders.ts" kind="source-edit"/>
            <file path="domain/projects/use-cases/progress-design-step.ts" kind="source-edit"/>
            <file path="domain/production/services.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[샘플 프로젝트 시나리오 3건에서 project status와 workorder/process status 불일치 건수가 0건이다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="high"><![CDATA[상태 전이 규칙 충돌 시 현장 UX가 차단될 수 있다.]]></risk>
          </risks>
        </task>

        <task id="T8" status="done" owner="executor" dependsOn="T7,T6" updatedAt="2026-02-10">
          <summary><![CDATA[프로젝트 E2E 타임라인(설계/자재/생산) 단일 뷰 추가]]></summary>
          <details><![CDATA[
표시 범위:
- 수주 확정일
- 설계 step 완료 이력
- PR/PO/입고 이정표
- 주요 WorkOrder 시작/완료
기존 프로젝트 상세 페이지에 섹션 추가로 구현(새 프레임워크 도입 금지).
]]></details>
          <outputs>
            <file path="app/projects/[id]/page.tsx" kind="source-edit"/>
            <file path="hooks/projects/useProjects.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[프로젝트 상세에서 시간순 타임라인 항목(수주/설계/구매/생산) 4종이 모두 조회된다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="medium"><![CDATA[데이터 소스가 분산되어 정렬/중복 제거 로직이 필요하다.]]></risk>
          </risks>
        </task>
      </tasks>
    </phase>

    <phase id="P5" name="회계/검증/운영 고도화" status="done">
      <tasks>
        <task id="T9" status="done" owner="executor" dependsOn="T5,T7" updatedAt="2026-02-10">
          <summary><![CDATA[STOCK_OUT 자동분개 연결 및 프로젝트 원가 반영]]></summary>
          <details><![CDATA[
현재 ORDER/PAYMENT/PO는 자동분개가 있으나 STOCK_OUT 자동 트리거는 미연결.
보강:
- useStocks.stockOut 성공 시 STOCK_OUT accounting event 게시
- payload에 project_id/material_id/amount 일관 세팅
- 분개 라인(project_id) 추적성 확보
]]></details>
          <outputs>
            <file path="hooks/materials/useStocks.ts" kind="source-edit"/>
            <file path="domain/accounting/services.ts" kind="source-edit"/>
            <file path="domain/accounting/use-cases/post-accounting-event.ts" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[STOCK_OUT 이벤트 1건당 분개 1전표(2라인)가 생성되고 차변합=대변합=amount를 만족한다.]]></criterion>
            <criterion><![CDATA[분개 라인의 project_id 누락률은 0%다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="high"><![CDATA[금액 산정(이동평균단가) 기준 불일치 시 회계 오류로 이어질 수 있다.]]></risk>
          </risks>
        </task>

        <task id="T10" status="done" owner="executor" dependsOn="T1A,T5,T7,T9" updatedAt="2026-02-10">
          <summary><![CDATA[정합성 체크 페이지/훅 도입 (hydration 비의존)]]></summary>
          <details><![CDATA[
최소 지표:
- project_id 누락률(PR/PO/StockMovement/WorkOrder/JournalLine)
- 상태 불일치 건수(project status vs process/workorder)
- 문서 연결 누락률(PO<-PR, Movement<-PO, WorkOrder<-ProcessStep)

주의:
- hooks/admin/useInitialHydration.ts를 다시 비대화하지 않는다.
- 별도 query 훅/페이지로 구현한다.
]]></details>
          <outputs>
            <file path="hooks/admin/useDataIntegrityChecks.ts" kind="source-edit"/>
            <file path="app/admin/data-integrity/page.tsx" kind="source-edit"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[정합성 페이지에서 3개 지표군을 모두 조회할 수 있다.]]></criterion>
            <criterion><![CDATA[신규 데이터(컷오버 이후)의 project_id 누락률은 0%로 표시된다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="medium"><![CDATA[조회 쿼리가 무거우면 배치 점검으로 분리 필요.]]></risk>
          </risks>
        </task>

        <task id="T12" status="done" owner="executor" dependsOn="T1A,T5" updatedAt="2026-02-10">
          <summary><![CDATA[기존 데이터 백필/정리 수행]]></summary>
          <details><![CDATA[
백필 범위:
- project_id 누락 PO를 PR/po_id 연결 규칙으로 보정
- movement/steel_tag의 project_id를 PO/PR 기준으로 보정 가능한 건만 채움
- 보정 불가 건은 exception 목록으로 분리
]]></details>
          <outputs>
            <file path="supabase/migrations/*_backfill_project_refs.sql" kind="source-edit"/>
            <file path="plans/project-e2e-flow-consistency-handoff.md" kind="handoff-update"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[백필 대상 중 자동 보정 가능 건의 처리율이 95% 이상이다.]]></criterion>
            <criterion><![CDATA[보정 불가 건은 100% 예외 목록으로 추출된다.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="high"><![CDATA[잘못된 백필 규칙은 과거 원장/재고 추적을 손상시킬 수 있다.]]></risk>
          </risks>
        </task>

        <task id="T11" status="done" owner="executor" dependsOn="T10,T12" updatedAt="2026-02-10">
          <summary><![CDATA[단계적 롤아웃 및 종료 검증]]></summary>
          <details><![CDATA[
검증 시나리오:
1) Sales→Project 생성
2) Design 완료→PR 생성
3) 혼합 프로젝트 PR→PO 자동 분할 생성
4) 입고 시 movement/tag project_id 전파
5) 출고→WorkOrder→프로젝트 상태 갱신
6) STOCK_OUT 회계 분개 반영

필수 게이트:
- npm run lint
- npm run build
- 시나리오 6건 수동 체크리스트 통과
]]></details>
          <outputs>
            <file path="plans/project-e2e-flow-consistency-plan.xml" kind="plan-update"/>
          </outputs>
          <acceptance>
            <criterion><![CDATA[6개 E2E 시나리오 전부 PASS, 치명 결함 0건.]]></criterion>
            <criterion><![CDATA[컷오버 이후 생성 데이터의 project_id 누락률 0% 유지.]]></criterion>
          </acceptance>
          <risks>
            <risk severity="medium"><![CDATA[백필 규칙 미완성 상태에서 롤아웃하면 과거 조회 일관성이 저하될 수 있다.]]></risk>
          </risks>
        </task>
      </tasks>
    </phase>
  </phases>

  <externalChanges>
    <change target="domain/shared/entities.ts" owner="executor"><![CDATA[project trace 필드/계약 강화]]></change>
    <change target="domain/procurement/use-cases/convert-requests-to-po.ts" owner="executor"><![CDATA[혼합 프로젝트 자동 분할 + purchaseOrders[] 반환]]></change>
    <change target="hooks/procurement/usePurchaseRequests.ts" owner="executor"><![CDATA[convertRequestsToPO 계약 다건 반환으로 변경]]></change>
    <change target="hooks/procurement/usePurchaseRequestsPageData.ts" owner="executor"><![CDATA[다건 PO 생성 결과 UI 처리]]></change>
    <change target="app/materials/purchase-requests/page.tsx" owner="executor"><![CDATA[다건 생성 피드백/네비게이션 반영]]></change>
    <change target="lib/supabase/materials.ts" owner="executor"><![CDATA[PO project_id read/write 반영]]></change>
    <change target="infrastructure/repositories/supabase/procurement.ts" owner="executor"><![CDATA[PO project_id repository 반영]]></change>
    <change target="infrastructure/repositories/in-memory/procurement.ts" owner="executor"><![CDATA[PO project_id repository 반영]]></change>
    <change target="supabase/migrations/*_add_project_id_to_purchase_orders.sql" owner="executor"><![CDATA[PO project_id 컬럼/인덱스/제약 추가]]></change>
    <change target="supabase/migrations/*_backfill_project_refs.sql" owner="executor"><![CDATA[과거 데이터 project reference 백필]]></change>
    <change target="domain/sales/use-cases/create-order-with-project.ts" owner="executor"><![CDATA[프로젝트 초기 공정 seed/idempotency 연계]]></change>
    <change target="domain/projects/use-cases/progress-design-step.ts" owner="executor"><![CDATA[설계 이후 게이트 연계 강화]]></change>
    <change target="domain/materials/use-cases/receive-purchase-order.ts" owner="executor"><![CDATA[입고 movement project_id 전파]]></change>
    <change target="hooks/materials/useStocks.ts" owner="executor"><![CDATA[STOCK_OUT 자동분개 트리거 연결]]></change>
    <change target="hooks/procurement/usePurchaseRequestForm.ts" owner="executor"><![CDATA[PR project_id 검증/승계 강화]]></change>
    <change target="hooks/production/useWorkOrders.ts" owner="executor"><![CDATA[process_step 기반 상태 동기화]]></change>
    <change target="hooks/admin/useDataIntegrityChecks.ts" owner="executor"><![CDATA[정합성 체크 전용 query 훅 추가]]></change>
    <change target="app/admin/data-integrity/page.tsx" owner="executor"><![CDATA[정합성 체크 페이지 추가]]></change>
    <change target="app/projects/[id]/page.tsx" owner="executor"><![CDATA[프로젝트 E2E 타임라인/집행 상태 뷰 추가]]></change>
  </externalChanges>

  <handoff>
    <forExecutor><![CDATA[
실행 우선순위:
1) P1(계약/저장소/DB)
2) P3(자재·구매 전파)
3) P2/P4(상태 동기화)
4) P5(회계/정합성/백필)

계약 변경 핵심:
- convertRequestsToPO: PurchaseOrder 단건 반환 -> purchaseOrders[] 다건 반환
- 혼합 프로젝트 승인 PR은 자동 분할 생성(실패 처리 아님)

가드레일:
- hooks/admin/useInitialHydration.ts 재확장 금지
- 이벤트 버스/대형 오케스트레이터 신규 도입 금지
- 전역 추상화보다 도메인별 명시 로직 우선
]]></forExecutor>
    <forReviewer><![CDATA[
리뷰 체크리스트:
1) project reference가 Sales/Design/Procurement/Materials/Production/Accounting 전 경로에서 이어지는가?
2) convertRequestsToPO 다건 계약으로 인한 호출부 누락이 없는가?
3) DB 마이그레이션 + repository + lib/supabase 반영이 모두 동기화됐는가?
4) 신규 데이터 누락률 0%, E2E 6시나리오 PASS를 증빙했는가?
5) 구현이 최소 변경 원칙(오버엔지니어링 배제)을 지키는가?
]]></forReviewer>
  </handoff>

  <changeLog>
    <change when="2026-02-10" who="planner" type="init"><![CDATA[프로젝트별 E2E 데이터 플로우 일관성 계획 신규 작성.]]></change>
    <change when="2026-02-10" who="planner" type="replan"><![CDATA[
change: 깊은 리뷰 결과(다건 PO 계약 충돌, DB/Repository 단계 누락, 정량 수용기준 부재, 백필 task 부재)를 반영해 계획 전면 보강.
impact: P1/P5에 저장소/마이그레이션/백필/정합성 검증 task가 추가되고, PR→PO 정책이 자동 분할로 고정됨.
nextAction: T1 -> T1A -> T2 순으로 계약/저장소/호출부를 먼저 안정화.
]]></change>
    <change when="2026-02-10" who="executor" type="execution-complete"><![CDATA[
P0~P5 전 태스크(T0~T12) 실행 완료.
T1: PurchaseOrder.project_id 추가, PO_ORDERED 분개에 project_id 반영
T1A: purchase_orders.project_id DB 마이그레이션 + 인덱스 + FK
T2: ConvertRequestsToPO 다건 반환(purchaseOrders[]) + 프로젝트별 자동 분할
T3: 수주 생성 시 DESIGN_3D/2D/REVIEW/BOM step 자동 생성 (idempotent)
T4: DESIGN_BOM 완료 시 BOM→PR 자동 생성 use case + hook
T5: PO 입고 시 StockMovement/SteelTag에 project_id 전파
T6: 프로젝트별 자재 소요/집행 KPI 6개 지표
T7: WorkOrder START/COMPLETE → ProcessStep/Project 상태 동기화
T8: 프로젝트 E2E 타임라인 (수주/설계/구매/생산)
T9: STOCK_OUT 자동분개 트리거 연결
T10: 데이터 정합성 점검 페이지 (/admin/data-integrity)
T12: 과거 데이터 백필 마이그레이션
T11: 최종 검증 (tsc 0 errors, build 48 routes OK, lint 0 errors)
]]></change>
  </changeLog>
</plan>
